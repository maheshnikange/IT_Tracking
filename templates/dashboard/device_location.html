<!DOCTYPE html>
<html>
<head>
    <title>Device Location</title>
    <style>
        #map { height: 500px; width: 100%; }
    </style>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet/dist/leaflet.css"
    />
</head>
<body>

<h1>Location of {{ device.hostname }}</h1>

{% if device.latitude and device.longitude %}
    <!-- Store data in hidden spans for safe JS parsing -->
    <span id="lat-data" style="display:none;">{{ device.latitude|json_script:"lat-data" }}</span>
    <span id="lng-data" style="display:none;">{{ device.longitude|json_script:"lng-data" }}</span>
    {% if device.accuracy_meters %}
        <span id="accuracy-data" style="display:none;">{{ device.accuracy_meters|json_script:"accuracy-data" }}</span>
    {% endif %}

    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // Parse latitude and longitude safely
        const latitude = JSON.parse(document.getElementById("lat-data").textContent);
        const longitude = JSON.parse(document.getElementById("lng-data").textContent);
        const accuracyElem = document.getElementById("accuracy-data");
        const accuracy = accuracyElem ? JSON.parse(accuracyElem.textContent) : null;

        // Initialize map
        const map = L.map('map').setView([latitude, longitude], 15);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        // Add marker
        L.marker([latitude, longitude])
            .addTo(map)
            .bindPopup("{{ device.hostname }}")
            .openPopup();

        // Optional: add accuracy circle
        if (accuracy) {
            L.circle([latitude, longitude], {
                radius: accuracy,
                color: 'blue',
                fillOpacity: 0.1
            }).addTo(map);
        }
    </script>

{% else %}
    <p style="color:red;">Location not available yet</p>
{% endif %}

</body>
</html>
